name: Stage build and deploy

on:
  push:
    branches:
      - main
    workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  publish:
    runs-on: ubuntu-latest 
    permissions: 
      contents: read
      packages: write 
    steps:

      - uses: actions/checkout@v3

      #- run: source ./setenv-stage.sh ;
      #- run: source ./setenv-stage.sh
      - run: mkdir -p './mirror'
      - run: SPRING_PROFILES_ACTIVE=stage docker compose --file ./docker-compose-mount-content.yml build --no-cache --pull ;
      - run: SPRING_PROFILES_ACTIVE=stage docker compose --file ./docker-compose-mount-content.yml up --force-recreate --detach --wait ;
      - run: SPRING_PROFILES_ACTIVE=stage docker compose build --no-cache --pull ;
      - run: SPRING_PROFILES_ACTIVE=stage docker compose up --force-recreate --detach --wait ;
      - run: ./create-mirror-from-cluster.sh

      #- run: aws s3 sync './mirror' "s3://www.stage.diyaccounting.co.uk/" --exclude '*content*' --delete --acl public-read ;
      #- run: aws s3 sync './mirror' "s3://www.stage.diyaccounting.co.uk/" --exclude '*' --include '*content*'  --content-type 'application/javascript' --delete --acl public-read ;
      #- run: aws s3 ls --summarize --human-readable "s3://www.stage.diyaccounting.co.uk"
